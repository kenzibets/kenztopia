<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Monster Slots — Single-file HTML</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&family=Nosifer&display=swap" rel="stylesheet">
<style>
:root{
  --accent-green:#0cf04a;
  --muted:#bfc7c3;
  --bg:#070606;
}
/* Base */
html,body{height:100%;margin:0;background:linear-gradient(180deg,#060606,#0b0b0b);color:#fff;font-family:Rubik,system-ui,-apple-system,"Segoe UI",Roboto,Arial;overflow:hidden}
::-webkit-scrollbar { width: 0; height: 0 }
body { scrollbar-width: none; -ms-overflow-style: none; }

/* background + green streak */
body::before{
  content:""; position:fixed; inset:0; z-index:-3;
  background:
    linear-gradient(180deg, rgba(0,0,0,0.55) 0%, rgba(8,8,8,0.85) 100%),
    url('https://source.unsplash.com/1600x900/?grunge,black,wall') center/cover no-repeat;
  mix-blend-mode:multiply; opacity:0.95;
}
body::after{
  content:""; position:fixed; left:-20%; top:-10%; width:140%; height:120%; z-index:-2;
  background: radial-gradient(40% 60% at 10% 20%, rgba(12,240,74,0.06), transparent 8%),
              radial-gradient(30% 60% at 80% 80%, rgba(12,240,74,0.035), transparent 12%);
  filter:blur(18px); pointer-events:none;
}

/* memes mode (kept minimal) */
body.memes-mode {
  background: linear-gradient(180deg,#f7f7f7,#e9e9e9);
  color: #0b0b0b;
}
body.memes-mode::before {
  background:
    linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.9) 100%),
    url('https://source.unsplash.com/1600x900/?grunge,white,wall') center/cover no-repeat;
  mix-blend-mode: normal; opacity:0.96;
}
body.memes-mode::after { filter: blur(6px); opacity:0.08; }

/* layout */
.wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:28px;overflow:auto}
.card{width:1150px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.45));border-radius:12px;padding:18px;box-shadow:0 28px 80px rgba(0,0,0,0.95);display:grid;grid-template-columns:1fr 440px;gap:18px;border:4px solid rgba(0,0,0,0.7)}
header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding-bottom:6px}
header h1{margin:0;font-size:24px;letter-spacing:1px;font-weight:900;color:var(--accent-green)}
body.memes-mode header h1{color:#111111}
.subtitle{color:var(--muted);font-size:13px}

/* board */
.board-area{padding:8px;border-radius:8px;display:flex;flex-direction:column;gap:12px;align-items:center;position:relative;overflow:visible}
.controls{display:flex;align-items:center;gap:10px;width:100%;justify-content:space-between}
.left-controls{display:flex;gap:12px;align-items:center}
.btn{background:linear-gradient(180deg,#0bf04a,#0a7e2e);border:none;padding:12px 20px;border-radius:10px;color:#050505;font-weight:900;cursor:pointer;box-shadow:0 10px 22px rgba(11,180,60,0.08)}
body.memes-mode .btn { background: linear-gradient(180deg,#ffffff,#e6e6e6); color:#111; box-shadow:0 8px 18px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06) }
.small{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
body.memes-mode .small{ border-color: rgba(0,0,0,0.06); color: #555; background: rgba(255,255,255,0.7) }

input[type=number]{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;color:var(--muted);border-radius:8px}
body.memes-mode input[type=number]{ background: rgba(255,255,255,0.95); color:#111; border-color: rgba(0,0,0,0.06) }

/* board grid (5 x 3) */
.board{display:grid;grid-template-columns: repeat(5, 1fr);gap:12px;align-items:stretch;justify-items:stretch;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.14));border-radius:12px;border-left:10px solid rgba(0,0,0,0.9);position:relative;min-height:360px}
body.memes-mode .board { background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(250,250,250,0.9)); border-left-color: rgba(0,0,0,0.06) }
.col{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;position:relative;border-top:6px solid rgba(0,0,0,0.9);transition:transform .18s}
body.memes-mode .col { background: rgba(255,255,255,0.9); border-top-color: rgba(0,0,0,0.06) }
.cell{width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:8px;background:rgba(0,0,0,0.04);border-radius:6px}
body.memes-mode .cell{ background: rgba(255,255,255,0.98) }
.cell img{width:92px;height:92px;object-fit:contain;transition:transform .35s,filter .25s}
.cell .name{font-size:12px;color:var(--muted);margin-top:8px}

/* multiplier overlay per column */
.col .col-mult{position:absolute;left:50%;transform:translateX(-50%);top:8px;font-family:"Nosifer","Rubik",sans-serif;font-size:46px;color:var(--accent-green);pointer-events:none;text-shadow:0 2px 0 rgba(0,0,0,0.9);opacity:0.95;transition:transform .25s,opacity .18s;letter-spacing:6px}
.col .col-mult.small{font-size:28px;top:auto;bottom:12px;opacity:.7}
.col .col-mult.hidden{opacity:0;transform:translateX(-50%) scale(.92)}
body.memes-mode .col .col-mult { color: #111; text-shadow: none }

/* states */
.col.spinning img{transform:translateY(-6px) scale(.98)}
.col.win{box-shadow:0 12px 44px rgba(12,240,74,0.22), inset 0 0 18px rgba(12,240,74,0.06);transform:translateY(-6px);transition:transform .22s}
body.memes-mode .col.win{ box-shadow: 0 12px 44px rgba(0,0,0,0.06), inset 0 0 8px rgba(0,0,0,0.02) }
.col.bigwin{animation:colBig .9s ease 0s 1}
@keyframes colBig{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}

/* info area */
.info{background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.18));padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:12px}
body.memes-mode .info { background: rgba(255,255,255,0.96) }
.balance{font-size:36px;font-weight:900;color:var(--accent-green);letter-spacing:1px}
body.memes-mode .balance { color: #111 }
.muted{color:var(--muted);font-size:13px}
.payout-board{background:rgba(0,0,0,0.25);padding:10px;border-radius:6px;max-height:180px;overflow:auto}
.history{background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;max-height:220px;overflow:auto}
.history-item{display:flex;justify-content:space-between;padding:6px 0;align-items:center;opacity:0;animation:slideIn .32s ease forwards}
@keyframes slideIn{to{opacity:1;transform:none}from{opacity:0;transform:translateY(-8px)}}

/* memes UI - minimal per request (no extra text) */
#memesBox{border:2px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;background:rgba(0,0,0,0.06);display:block}

/* Win overlay (center) */
.win-overlay {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  z-index: 10000;
  min-width: 360px;
  max-width: 86%;
  background: rgba(8,8,8,0.95);
  color: #fff;
  border-radius: 12px;
  padding: 18px 22px;
  text-align: center;
  box-shadow: 0 30px 80px rgba(0,0,0,0.8);
  pointer-events: none;
  opacity: 0;
}
.win-overlay .title { font-family: Nosifer, Rubik, sans-serif; font-size: 28px; margin: 2px 0; letter-spacing: 2px; color: var(--accent-green); }
.win-overlay .amount { font-weight: 900; font-size: 34px; margin-top: 6px; }
.win-overlay.small { background: linear-gradient(180deg, rgba(0,0,0,0.92), rgba(0,0,0,0.95)); }
.win-overlay.mid { background: linear-gradient(180deg, rgba(6,20,6,0.96), rgba(10,40,10,0.97)); border: 1px solid rgba(12,240,74,0.08); }
.win-overlay.jackpot { background: linear-gradient(180deg, rgba(50,5,5,0.96), rgba(90,10,10,0.98)); border: 2px solid rgba(255,215,0,0.18); }

/* subtle animation presets */
.win-overlay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); transition: all 560ms cubic-bezier(.2,.9,.2,1); pointer-events: auto; }
@keyframes popScale { 0%{transform: translate(-50%,-50%) scale(0.7)} 60%{transform: translate(-50%,-50%) scale(1.08)} 100%{transform: translate(-50%,-50%) scale(1)} }
.win-overlay.pop { animation: popScale 700ms cubic-bezier(.2,.9,.2,1); }

/* small win pulse */
.win-overlay.pulse { animation: pulse 900ms ease-in-out; }
@keyframes pulse { 0% { transform: translate(-50%,-50%) scale(.9); } 50% { transform: translate(-50%,-50%) scale(1.03); } 100% { transform: translate(-50%,-50%) scale(1); } }

/* music player: keep compact and ensure playlist scrolls inside its box (doesn't push the page) */
.player{display:flex;flex-direction:column;gap:8px;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px;max-height:360px}
.player .playlist{background:rgba(0,0,0,0.06);padding:6px;border-radius:6px;max-height:140px;overflow:auto}
.player .progress{height:8px;background:rgba(255,255,255,0.04);border-radius:999px;position:relative;cursor:pointer}
.player .progress .bar{height:100%;background:linear-gradient(90deg,var(--accent-green),#6ff29a);width:0;border-radius:999px;transition:width .08s linear}
.player .time{font-size:12px;color:var(--muted);min-width:90px;text-align:right}

/* memetopia modal */
.modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:12000; pointer-events:none; opacity:0; transition:all .28s ease; }
.modal-overlay.active { pointer-events:auto; opacity:1; }
.modal { background: #0c0c0c; padding:18px 20px; border-radius:10px; color:#fff; min-width:320px; max-width:92%; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,0.6); }
.continue-btn { border: none; padding:10px 16px; border-radius:8px; font-weight:900; cursor:pointer; margin-top:12px; background: linear-gradient(180deg,#0bf04a,#0a7e2e); color:#050505; }
.continue-btn.flash { animation: flashBtn 1200ms infinite; }
@keyframes flashBtn { 0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)} }

/* responsive */
@media (max-width:1200px){ .card{width:95%} .cell img{width:72px;height:72px} }
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="card" role="application" id="card">
    <header>
      <div>
        <h1 id="title">Monster Slots <span style="font-size:12px;color:var(--muted);font-weight:600">— Memes & Win SFX (Single-file)</span></h1>
        <div class="subtitle">Local music folder only — select folder in the player.</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Theme</div>
        <div style="font-weight:700;color:var(--muted)">Monster • Grunge</div>
      </div>
    </header>

    <!-- LEFT: slot board -->
    <div class="board-area" id="boardArea">
      <div class="controls">
        <div class="left-controls">
          <div>
            <div class="muted">Balance</div>
            <div id="balance" class="balance">500.00</div>
          </div>
          <div>
            <div class="muted">Bet</div>
            <div id="betWrap"><input id="betInput" type="number" value="10" min="1" step="1" style="width:90px;"></div>
          </div>
          <button id="maxBtn" class="small">MAX</button>
          <button id="clearBtn" class="small">RESET BAL</button>

          <!-- MEMES MODE BUTTON -->
          <button id="memesBtn" class="small">Activate Memes Mode</button>

        </div>

        <!-- Play area (SPIN + AUTO horizontally) -->
        <div style="display:flex;gap:12px;align-items:center">
          <div style="text-align:center">
            <div class="muted">Play</div>
            <div id="buttonArea" style="margin-top:6px">
              <button id="spinBtn" class="btn">SPIN</button>
              <button id="autoBtn" class="small" style="margin-left:8px">AUTO 10</button>
            </div>
            <div id="lastWin" class="muted" style="margin-top:6px">—</div>
          </div>
        </div>
      </div>

      <div class="board" id="board" aria-hidden="false"></div>

      <div class="particles" id="particles"></div>

      <!-- Memes mode minimal UI -->
      <div id="memesBox" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Memes mode</strong></div>
          <div style="display:flex;gap:10px;align-items:center"></div>
        </div>
      </div>

    </div>

    <!-- RIGHT: info + player -->
    <aside class="info" aria-label="Info & Player">
      <div>
        <div class="muted">Payout board</div>
        <div style="font-weight:700">Center-row payouts</div>
      </div>
      <div class="payout-board" id="payoutBoard"></div>

      <div>
        <div class="muted">Spin history</div>
        <div class="history" id="history"></div>
      </div>

      <div>
        <div class="muted">Music Player (background)</div>
        <div class="player">
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small" style="padding:6px 8px;cursor:pointer">
              Select folder
              <input id="folderInput" type="file" webkitdirectory directory multiple style="display:none">
            </label>
            <button id="shuffleBtn" class="small">Shuffle: OFF</button>
            <button id="loopBtn" class="small">Loop: ON</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevBtn" class="small">Prev</button>
            <button id="playBtn" class="small">Play</button>
            <button id="nextBtn" class="small">Next</button>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7" style="flex:1">
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div class="progress" id="progress">
                <div class="bar" id="progressBar"></div>
              </div>
            </div>
            <div class="time" id="timeLabel">0:00 / 0:00</div>
          </div>

          <div class="playlist" id="playlist" aria-live="polite" style="min-height:40px"></div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Memetopia modal (non-blocking; spin still works) -->
<div id="memetopiaModal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="memetopiaTitle">
    <h2 id="memetopiaTitle">Memetopia</h2>
    <p id="memetopiaBody">Memes mode active. Press Continue to dismiss.</p>
    <button id="memetopiaContinue" class="continue-btn flash">CONTINUE</button>
  </div>
</div>

<!-- Win overlay (count-up and per-win animation) -->
<div id="winOverlay" class="win-overlay hidden" aria-hidden="true">
  <div class="title" id="winTitle">YOU WIN</div>
  <div class="amount" id="winAmount">$0.00</div>
  <div class="subtitle muted" id="winSub" style="margin-top:6px;font-size:13px"></div>
</div>

<script>
/* Single-file client-side implementation of the slot machine
   - No server. All spin/payout logic in JS (matches your server logic).
   - Only local folder input: music player (webkitdirectory). Playlist scrolls inside box.
   - Memes mode toggles theme; uses same builtin SYMBOL images (no server autoload).
   - Win overlay count-up + per-tier animations.
*/

/* ---------------------------
   Constants (symbols, weights)
   --------------------------- */
const symbolImages = [
    'https://github.com/kenzibets/socials/raw/main/green.png',
    'https://github.com/kenzibets/socials/raw/main/red.png',
    'https://github.com/kenzibets/socials/raw/main/white.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-56.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-51.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-50.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-71.png',
    'https://pngfre.com/wp-content/uploads/Monster-8.png',
    'https://pngfre.com/wp-content/uploads/Monster-24.png'
];

const SYMBOLS = [
    {"id": 0, "name": "Green Slash", "img": symbolImages[0], "mult3": 50, "mult2": 5},
    {"id": 1, "name": "Red Slash",   "img": symbolImages[1], "mult3": 30, "mult2": 4},
    {"id": 2, "name": "White Slash", "img": symbolImages[2], "mult3": 20, "mult2": 3},
    {"id": 3, "name": "Monster A",   "img": symbolImages[3], "mult3": 12, "mult2": 2},
    {"id": 4, "name": "Monster B",   "img": symbolImages[4], "mult3": 8,  "mult2": 1.5},
    {"id": 5, "name": "Monster C",   "img": symbolImages[5], "mult3": 6,  "mult2": 1.2},
    {"id": 6, "name": "Monster D",   "img": symbolImages[6], "mult3": 40, "mult2": 6},
    {"id": 7, "name": "Monster E",   "img": symbolImages[7], "mult3": 10, "mult2": 1.8},
    {"id": 8, "name": "Monster F",   "img": symbolImages[8], "mult3": 7,  "mult2": 1.3},
];

const WEIGHTED_SYMBOL_IDS = (
    Array(6).fill(0).concat(Array(8).fill(1)).concat(Array(12).fill(2))
    .concat(Array(16).fill(3)).concat(Array(20).fill(4)).concat(Array(30).fill(5))
    .concat(Array(10).fill(6)).concat(Array(14).fill(7)).concat(Array(18).fill(8))
);

/* Board */
const COLUMNS = 5;
const ROWS = 3;

/* App state */
let balance = 500.00;
let autoRunning = false;
let autoLeft = 0;

/* DOM refs */
const balanceEl = document.getElementById('balance');
const betInput = document.getElementById('betInput');
const betWrap = document.getElementById('betWrap');
const spinBtn = document.getElementById('spinBtn');
const autoBtn = document.getElementById('autoBtn');
const lastWin = document.getElementById('lastWin');
const boardEl = document.getElementById('board');
const payoutBoardEl = document.getElementById('payoutBoard');
const historyEl = document.getElementById('history');
const maxBtn = document.getElementById('maxBtn');
const clearBtn = document.getElementById('clearBtn');
const particlesRoot = document.getElementById('particles');

const memesBtn = document.getElementById('memesBtn');
const memetopiaModal = document.getElementById('memetopiaModal');
const memetopiaContinue = document.getElementById('memetopiaContinue');
const memetopiaBody = document.getElementById('memetopiaBody');

const folderInput = document.getElementById('folderInput'); // local music loader
const playlistEl = document.getElementById('playlist');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const vol = document.getElementById('vol');
const loopBtn = document.getElementById('loopBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const timeLabel = document.getElementById('timeLabel');

const winOverlay = document.getElementById('winOverlay');
const winTitle = document.getElementById('winTitle');
const winAmountEl = document.getElementById('winAmount');
const winSub = document.getElementById('winSub');

let playlist = []; // background music playlist
let audio = new Audio();
audio.volume = Number(vol.value);
let currentIndex = 0;
let loopAudio = true;
let shuffleAudio = false;
loopBtn.textContent = 'Loop: ON';
shuffleBtn.textContent = 'Shuffle: OFF';

/* Memes & SFX state (no server) - memesMode simply toggles theme and uses default SYMBOLS images */
let memeImages = [];   // not used for server autoload in this single-file version
let sfxWins = [];      // left empty (no server)
let sfxLose = [];      // left empty
let memesMode = false;

/* helpers */
function setBalance(v){ balance = Math.max(0, Math.round(v*100)/100); balanceEl.textContent = balance.toFixed(2); }
setBalance(balance);

function fmtTime(s){ if(!isFinite(s)) return '0:00'; s = Math.max(0, Math.floor(s)); return Math.floor(s/60) + ':' + (s%60<10 ? '0'+(s%60) : (s%60)); }

/* Build board */
function buildBoard(){
  boardEl.innerHTML = '';
  for(let c=0;c<COLUMNS;c++){
    const col = document.createElement('div');
    col.className = 'col';
    col.id = `col-${c}`;
    const mult = document.createElement('div');
    mult.className = 'col-mult hidden';
    mult.id = `col-mult-${c}`;
    mult.textContent = 'X1';
    col.appendChild(mult);
    for(let r=0;r<ROWS;r++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.innerHTML = `<img src="" alt=""><div class="name">---</div>`;
      col.appendChild(cell);
    }
    boardEl.appendChild(col);
  }
}
buildBoard();

/* payout board */
function populatePayoutBoard(){
  payoutBoardEl.innerHTML = '';
  const sorted = SYMBOLS.slice().sort((a,b)=>b.mult3 - a.mult3);
  for(const s of sorted){
    const row = document.createElement('div');
    row.className = 'payout-row';
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${s.img}" style="width:34px;height:34px;object-fit:contain">
        <div style="line-height:1">
          <div style="font-weight:700">${s.name}</div>
          <div class="muted" style="font-size:12px">3+ center → ${s.mult3}x • pair → ${s.mult2}x</div>
        </div>
      </div>
      <div style="text-align:right"><div class="muted">id ${s.id}</div></div>
    `;
    payoutBoardEl.appendChild(row);
  }
}
populatePayoutBoard();

/* random util */
function randInt(max){ return Math.floor(Math.random()*max); }

/* animate helpers */
function burstAt(x,y,color='rgba(12,240,74,0.95)'){
  const count = 18;
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.style.position='absolute';
    p.style.left = `${x}px`; p.style.top = `${y}px`;
    p.style.width='8px'; p.style.height='8px'; p.style.borderRadius='50%';
    p.style.background = color; p.style.opacity = Math.random()*0.9 + 0.3;
    p.style.pointerEvents = 'none'; p.style.mixBlendMode = 'screen';
    particlesRoot.appendChild(p);
    const angle = Math.random()*Math.PI*2;
    const dist = 20 + Math.random()*80;
    const dx = Math.cos(angle)*dist; const dy = Math.sin(angle)*dist;
    p.animate([{ transform: `translate(0px,0px) scale(1)`, opacity: p.style.opacity },{ transform: `translate(${dx}px,${dy}px) scale(.6)`, opacity: 0 }], { duration: 700 + Math.random()*400, easing: 'cubic-bezier(.16,.85,.4,1)'});
    setTimeout(()=> p.remove(), 1200);
  }
}
function cameraShake(){
  const card = document.getElementById('card');
  card.animate([{ transform: 'translateY(0)' },{ transform: 'translateY(-6px)' },{ transform: 'translateY(3px)' },{ transform: 'translateY(-4px)' },{ transform: 'translateY(2px)' },{ transform: 'translateY(0)' }], { duration: 600, iterations: 1, easing: 'cubic-bezier(.16,.85,.4,1)'});
}

/* animate single column (concurrent spin) */
function animateColumn(colIndex, finalColSymbols){
  return new Promise(res=>{
    const colEl = document.getElementById(`col-${colIndex}`);
    const imgs = colEl.querySelectorAll('.cell img');
    const names = colEl.querySelectorAll('.cell .name');
    colEl.classList.add('spinning');
    const ints = [];
    for(let r=0;r<ROWS;r++){
      ints[r] = setInterval(()=>{
        // flicker random (memesMode uses same SYMBOLS in this file)
        const s = SYMBOLS[randInt(SYMBOLS.length)];
        imgs[r].src = s.img;
        names[r].textContent = s.name;
      }, 50);
    }
    for(let r=0;r<ROWS;r++){
      const stopAt = 360 + r*90 + Math.random()*120;
      setTimeout(()=>{
        clearInterval(ints[r]);
        imgs[r].src = finalColSymbols[r].img;
        names[r].textContent = finalColSymbols[r].name;
        imgs[r].animate([{ transform: 'translateY(-8px) scale(.96)' }, { transform: 'translateY(0) scale(1)' }], { duration: 300, easing: 'cubic-bezier(.2,.9,.2,1)' });
      }, stopAt);
    }
    const finishAt = 360 + (ROWS-1)*90 + 220;
    setTimeout(()=>{ colEl.classList.remove('spinning'); res(); }, finishAt+80);
  });
}

/* determine winners on center row */
function winningIndicesCenter(resp){
  if(!resp || resp.win_type === 'none') return [];
  const center = resp.center_row;
  if(resp.win_type === '3x'){
    let winId = null;
    for(let i=0;i<center.length;i++){
      if(center.filter(x=>x===center[i]).length >= 3){ winId = center[i]; break; }
    }
    if(winId===null) return [];
    const idxs = [];
    for(let i=0;i<center.length;i++) if(center[i]===winId) idxs.push(i);
    return idxs;
  } else if(resp.win_type === '2x'){
    let pairId = null;
    const counts = {};
    for(let i=0;i<center.length;i++) counts[center[i]] = (counts[center[i]]||0)+1;
    for(const id in counts) if(counts[id]===2){ pairId = Number(id); break; }
    const idxs = [];
    for(let i=0;i<center.length;i++) if(center[i]===pairId) idxs.push(i);
    return idxs;
  }
  return [];
}

/* Play random win sfx if present in arrays (these arrays are empty in this file-only version) */
function playRandomWinSfx(){
  if(sfxWins.length === 0) return;
  const pick = sfxWins[randInt(sfxWins.length)];
  try { new Audio(pick.url).play().catch(()=>{}); } catch(e){}
}
function playRandomLoseSfx(){
  if(sfxLose.length === 0) return;
  const pick = sfxLose[randInt(sfxLose.length)];
  try { new Audio(pick.url).play().catch(()=>{}); } catch(e){}
}

/* Count-up display for wins */
function showWinOverlay(amount, winType, message){
  winOverlay.classList.remove('hidden','small','mid','jackpot','pop','pulse','show');
  void winOverlay.offsetWidth;
  if(winType === 'jackpot'){
    winOverlay.classList.add('jackpot','pop','show');
    winTitle.textContent = message || 'JACKPOT!';
    winSub.textContent = 'MEGA WIN';
  } else if(winType === 'mid'){
    winOverlay.classList.add('mid','pop','show');
    winTitle.textContent = message || 'BIG WIN';
    winSub.textContent = 'Nice hit!';
  } else {
    winOverlay.classList.add('small','pulse','show');
    winTitle.textContent = message || 'Win';
    winSub.textContent = '';
  }

  const start = 0;
  const end = Number(amount) || 0;
  const absEnd = Math.abs(end);
  let duration = 800;
  if(absEnd >= 200) duration = 1600;
  if(absEnd >= 1000) duration = 2600;
  if(winType === 'jackpot') duration = 3000;

  let startTime = null;
  function step(ts){
    if(!startTime) startTime = ts;
    const elapsed = ts - startTime;
    const t = Math.min(1, elapsed / duration);
    const eased = 1 - Math.pow(1 - t, 3);
    const current = start + (end - start) * eased;
    winAmountEl.textContent = `$${current.toFixed(2)}`;
    if(t < 1) requestAnimationFrame(step);
    else {
      setTimeout(()=> {
        winOverlay.classList.remove('show');
        setTimeout(()=> winOverlay.classList.add('hidden'), 500);
      }, 1100);
    }
  }
  requestAnimationFrame(step);

  if(winType === 'jackpot') cameraShake();
}

/* -------------- Spin logic (client-side) -------------- */
/* Re-implements the server-side spin logic so there's no Flask dependency */
function serverlessSpin(bet){
  // choose grid column-major using WEIGHTED_SYMBOL_IDS
  const grid_ids = [];
  for(let c=0;c<COLUMNS;c++){
    const col = [];
    for(let r=0;r<ROWS;r++){
      col.push( WEIGHTED_SYMBOL_IDS[randInt(WEIGHTED_SYMBOL_IDS.length)] );
    }
    grid_ids.push(col);
  }

  // Flatten symbol dicts column-major
  const grid_symbols = [];
  for(const col of grid_ids){
    for(const rid of col){
      grid_symbols.push(SYMBOLS.find(s => s.id === rid));
    }
  }

  // Evaluate center row
  const center_row_index = Math.floor(ROWS/2);
  const center_ids = [];
  for(let c=0;c<COLUMNS;c++) center_ids.push(grid_ids[c][center_row_index]);

  const counts = {};
  for(const id of center_ids) counts[id] = (counts[id]||0) + 1;

  let payout_multiplier = 0;
  let win_type = "none";
  let winning_symbol = null;

  for(const [ridStr, cnt] of Object.entries(counts)){
    const rid = Number(ridStr);
    if(cnt >= 3){
      const sym = SYMBOLS.find(s => s.id === rid);
      payout_multiplier = sym.mult3;
      win_type = "3x";
      winning_symbol = sym.name;
      break;
    }
  }
  if(payout_multiplier === 0){
    for(const [ridStr, cnt] of Object.entries(counts)){
      const rid = Number(ridStr);
      if(cnt === 2){
        const sym = SYMBOLS.find(s => s.id === rid);
        payout_multiplier = sym.mult2;
        win_type = "2x";
        winning_symbol = sym.name;
        break;
      }
    }
  }

  if(win_type === "2x" && center_ids.includes(6)) payout_multiplier *= 1.25;

  const win_amount = Math.round(bet * payout_multiplier * 100) / 100;

  return {
    grid: grid_ids,
    symbols: grid_symbols,
    center_row: center_ids,
    bet: bet,
    payout_multiplier: payout_multiplier,
    win_amount: win_amount,
    win_type: win_type,
    winning_symbol: winning_symbol,
    message: (win_type === "3x" ? "JACKPOT!" : (win_type === "2x" ? "Nice pair!" : "No win — try again."))
  };
}

/* Main spin flow */
async function doSpin(){
  spinBtn.disabled = true;
  const bet = Math.max(1, Number(betInput.value) || 1);
  if(bet > balance){ spinBtn.disabled = false; return; }
  setBalance(balance - bet);
  lastWin.textContent = '—';

  // get spin results from local function
  const resp = serverlessSpin(bet);

  // animate columns concurrently
  const colPromises = [];
  for(let c=0;c<COLUMNS;c++){
    const finalSymbols = resp.grid[c].map(id => SYMBOLS.find(s => s.id === id));
    colPromises.push( animateColumn(c, finalSymbols) );
  }

  // await finish
  await Promise.all(colPromises);

  // highlight winners and play sfx if win
  const winIdxs = winningIndicesCenter(resp);
  if(winIdxs.length > 0){
    for(let c=0;c<COLUMNS;c++){
      const multEl = document.getElementById(`col-mult-${c}`);
      if(winIdxs.includes(c)){
        multEl.textContent = resp.win_type === '3x' ? 'X3' : 'X2';
        multEl.classList.remove('hidden'); multEl.classList.remove('small');
        const colEl = document.getElementById(`col-${c}`);
        colEl.classList.add('win');
        if(resp.win_type === '3x'){ colEl.classList.add('bigwin'); setTimeout(()=>colEl.classList.remove('bigwin'),1200); }
        const centerCell = document.querySelector(`#col-${c} .cell:nth-child(${Math.floor(ROWS/2)+1})`);
        const rect = centerCell.getBoundingClientRect();
        const boardRect = boardEl.getBoundingClientRect();
        const x = rect.left + rect.width/2 - boardRect.left;
        const y = rect.top + rect.height/2 - boardRect.top;
        burstAt(x,y);
      } else {
        multEl.textContent = 'X1';
        multEl.classList.remove('hidden'); multEl.classList.add('small');
        setTimeout(()=>multEl.classList.add('hidden'),700);
      }
    }
    if(resp.win_type === '3x'){ cameraShake(); }
    playRandomWinSfx();
  } else {
    for(let c=0;c<COLUMNS;c++){
      const multEl = document.getElementById(`col-mult-${c}`);
      multEl.textContent = 'X1';
      multEl.classList.remove('hidden'); multEl.classList.add('small');
      setTimeout(()=>multEl.classList.add('hidden'),700);
    }
    playRandomLoseSfx();
  }

  // payout
  if(resp.win_amount > 0){
    setBalance(balance + resp.win_amount);
    lastWin.textContent = `Center multiplier: ${resp.payout_multiplier}x (${resp.win_type})`;

    let winTypeVisual = 'small';
    if(resp.win_type === '3x') winTypeVisual = 'jackpot';
    else if(resp.win_type === '2x') winTypeVisual = 'mid';
    let msg = resp.message;
    if(winTypeVisual === 'jackpot') msg = `JACKPOT — ${resp.winning_symbol || ''}`;
    else if(winTypeVisual === 'mid') msg = `Nice Pair — ${resp.winning_symbol || ''}`;
    else msg = `Win — ${resp.winning_symbol || ''}`;
    showWinOverlay(resp.win_amount, winTypeVisual, msg);
  } else {
    lastWin.textContent = 'No win';
  }

  // push history
  const historyRow = document.createElement('div');
  historyRow.className = 'history-item';
  const centerThumbs = resp.center_row.map(id => {
    const s = SYMBOLS.find(x=>x.id===id);
    return `<img src="${s.img}" style="width:24px;height:24px;object-fit:contain">`;
  }).join('');
  historyRow.innerHTML = `<div style="display:flex;gap:6px;align-items:center">${centerThumbs}</div><div style="font-weight:700">${resp.win_amount>0 ? `+${resp.win_amount.toFixed(2)}` : `-${bet.toFixed(2)}`}</div>`;
  historyEl.prepend(historyRow);
  while(historyEl.childElementCount > 40) historyEl.lastChild.remove();

  setTimeout(()=>{ for(let c=0;c<COLUMNS;c++){ document.getElementById(`col-${c}`).classList.remove('win'); } }, 1800);

  spinBtn.disabled = false;
}

/* ---------- controls ---------- */
spinBtn.addEventListener('click', ()=> doSpin());

autoBtn.addEventListener('click', async ()=>{
  if(autoRunning){ autoRunning=false; autoBtn.textContent='AUTO 10'; return; }
  autoRunning = true; autoLeft = 10; autoBtn.textContent = 'STOP AUTO';
  while(autoRunning && autoLeft>0){
    const bet = Math.max(1, Number(betInput.value) || 1);
    if(balance < bet){ autoRunning=false; break; }
    await doSpin();
    autoLeft--;
    await new Promise(r=>setTimeout(r, 520));
  }
  autoRunning = false; autoBtn.textContent='AUTO 10';
});

maxBtn.addEventListener('click', ()=> {
  const b = Math.max(1, Math.floor(balance * 0.1));
  betInput.value = b;
});

clearBtn.addEventListener('click', ()=> {
  if(confirm('Reset balance to 500.00?')) setBalance(500.00);
});

/* ---------- Memes Mode toggle (no server) ---------- */
memesBtn.addEventListener('click', async ()=>{
  memesMode = !memesMode;
  document.body.classList.toggle('memes-mode', memesMode);
  const title = document.getElementById('title');
  if(memesMode){
    title.textContent = 'Memes Mode Activated — Monster Slots';
    memesBtn.textContent = 'Deactivate Memes Mode';
    // update board visuals to symbol images (GIFs animate if they are GIFs)
    for(let c=0;c<COLUMNS;c++){
      const colEl = document.getElementById(`col-${c}`);
      const imgs = colEl.querySelectorAll('.cell img');
      const names = colEl.querySelectorAll('.cell .name');
      for(let r=0;r<ROWS;r++){
        const s = SYMBOLS[(c + r) % SYMBOLS.length];
        imgs[r].src = s.img;
        names[r].textContent = s.name;
      }
    }
    // show memetopia modal (non-blocking)
    memetopiaBody.textContent = `Memes mode active. GIFs (if used) will animate.`;
    memetopiaModal.style.display = 'flex';
    memetopiaModal.classList.add('active');
    memetopiaModal.setAttribute('aria-hidden', 'false');
  } else {
    title.textContent = 'Monster Slots — Memes & Win SFX';
    memesBtn.textContent = 'Activate Memes Mode';
    // restore random SYMBOL images
    for(let c=0;c<COLUMNS;c++){
      const colEl = document.getElementById(`col-${c}`);
      const imgs = colEl.querySelectorAll('.cell img');
      const names = colEl.querySelectorAll('.cell .name');
      for(let r=0;r<ROWS;r++){
        const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
        imgs[r].src = s.img;
        names[r].textContent = s.name;
      }
    }
    memetopiaModal.style.display = 'none';
    memetopiaModal.classList.remove('active');
    memetopiaModal.setAttribute('aria-hidden', 'true');
  }
});

/* Memetopia Continue button: hide modal (does not block spins) */
memetopiaContinue.addEventListener('click', ()=>{
  memetopiaModal.style.display = 'none';
  memetopiaModal.classList.remove('active');
  memetopiaModal.setAttribute('aria-hidden', 'true');
});

/* ---------- Background music player (local-folder loader) ---------- */
folderInput.addEventListener('change', (ev)=>{
  const files = Array.from(ev.target.files || []);
  const audioFiles = files.filter(f=>/\.(mp3|m4a|mp4|wav|ogg|webm)$/i.test(f.name));
  audioFiles.sort((a,b)=>a.name.localeCompare(b.name,'en',{numeric:true}));
  playlist.forEach(p=>{ if(p.file) URL.revokeObjectURL(p.url); });
  playlist = audioFiles.map(f => ({ name: f.name, url: URL.createObjectURL(f), file: f }));
  renderPlaylist();
  if(playlist.length>0){ currentIndex = 0; loadIndex(0); audio.play().catch(()=>{}); playBtn.textContent='Pause'; }
});

function renderPlaylist(){
  playlistEl.innerHTML = '';
  playlist.forEach((p,i)=>{
    const el = document.createElement('div');
    el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px';
    el.style.gap = '8px';
    el.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:28px;height:28px;background:rgba(255,255,255,0.02);border-radius:4px;display:flex;align-items:center;justify-content:center">${i+1}</div><div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px">${p.name}</div></div><div style="font-size:12px;color:var(--muted)">${i===currentIndex? 'Now' : ''}</div>`;
    el.addEventListener('click', ()=>{ loadIndex(i); audio.play(); playBtn.textContent='Pause'; });
    playlistEl.appendChild(el);
  });
}

function loadIndex(i){
  if(!playlist[i]) return;
  currentIndex = i;
  audio.src = playlist[i].url;
  renderPlaylist();
  updateTimeDisplay();
}

playBtn.addEventListener('click', ()=>{
  if(!audio.src){ if(playlist.length>0) loadIndex(0); else return; }
  if(audio.paused){ audio.play(); playBtn.textContent='Pause'; } else { audio.pause(); playBtn.textContent='Play'; }
});

prevBtn.addEventListener('click', ()=>{
  if(playlist.length===0) return;
  if(shuffleAudio){ currentIndex = Math.floor(Math.random()*playlist.length); }
  else currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  loadIndex(currentIndex); audio.play(); playBtn.textContent='Pause';
});
nextBtn.addEventListener('click', ()=>{
  if(playlist.length===0) return;
  if(shuffleAudio){ currentIndex = Math.floor(Math.random()*playlist.length); }
  else currentIndex = (currentIndex + 1) % playlist.length;
  loadIndex(currentIndex); audio.play(); playBtn.textContent='Pause';
});

vol.addEventListener('input', ()=> { audio.volume = Number(vol.value); });

loopBtn.addEventListener('click', ()=>{
  loopAudio = !loopAudio; loopBtn.textContent = loopAudio ? 'Loop: ON' : 'Loop: OFF'; audio.loop = loopAudio;
});
shuffleBtn.addEventListener('click', ()=>{
  shuffleAudio = !shuffleAudio; shuffleBtn.textContent = shuffleAudio ? 'Shuffle: ON' : 'Shuffle: OFF';
});

function updateTimeDisplay(){
  const cur = audio.currentTime || 0;
  const dur = audio.duration || 0;
  progressBar.style.width = dur ? ((cur/dur)*100)+'%' : '0%';
  timeLabel.textContent = `${fmtTime(cur)} / ${isFinite(dur) ? fmtTime(dur) : '0:00'}`;
}
audio.addEventListener('timeupdate', updateTimeDisplay);
audio.addEventListener('loadedmetadata', updateTimeDisplay);
audio.addEventListener('ended', ()=>{
  if(loopAudio){ audio.currentTime = 0; audio.play(); return; }
  if(playlist.length>0){
    if(shuffleAudio) currentIndex = Math.floor(Math.random()*playlist.length);
    else currentIndex = (currentIndex + 1) % playlist.length;
    loadIndex(currentIndex); audio.play();
  } else { playBtn.textContent = 'Play'; }
});
progress.addEventListener('click', (e)=>{
  const rect = progress.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const pct = Math.max(0, Math.min(1, x/rect.width));
  if(audio.duration) audio.currentTime = pct * audio.duration;
});

/* ---------------------------
   Initial visuals & float
   --------------------------- */
function initBoardVisuals(){
  for(let c=0;c<COLUMNS;c++){
    const colEl = document.getElementById(`col-${c}`);
    const imgs = colEl.querySelectorAll('.cell img');
    const names = colEl.querySelectorAll('.cell .name');
    for(let r=0;r<ROWS;r++){
      const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
      imgs[r].src = s.img; names[r].textContent = s.name;
    }
    const mult = document.getElementById(`col-mult-${c}`);
    mult.textContent = 'X1';
    mult.classList.remove('hidden');
    mult.classList.add('small');
  }
  setTimeout(()=> { for(let c=0;c<COLUMNS;c++) document.getElementById(`col-mult-${c}`).classList.add('hidden'); }, 700);
}
initBoardVisuals();

(function floatCols(){
  const root = boardEl;
  let t = 0;
  function frame(){
    t += 0.01;
    const cols = root.children;
    for(let i=0;i<cols.length;i++){
      const a = Math.sin(t + i*0.25)*1.6;
      cols[i].style.transform = `translateY(${a}px)`;
    }
    requestAnimationFrame(frame);
  }
  frame();
})();

/* cleanup object URLs on unload */
window.addEventListener('beforeunload', ()=>{
  playlist.forEach(p=>{ if(p.url && p.file) URL.revokeObjectURL(p.url); });
});
</script>
</body>
</html>
